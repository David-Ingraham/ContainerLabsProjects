# Multi-Vendor BGP Lab with API Control

A containerlab project demonstrating multi-vendor BGP configuration using vendor APIs (FRR CLI and GoBGP gRPC) with Ansible automation. Works on both macOS and Windows/WSL.

## Topology

```
client1 (10.0.1.1) <---> frr1 (AS 65001) <---> gobgp1 (AS 65002) <---> client2 (10.0.3.2)
```

- **client1/client2**: Alpine Linux hosts
- **frr1**: FRRouting BGP router (configured via vtysh CLI)
- **gobgp1**: GoBGP router (configured via gRPC API)

## Project Structure

```
multiVendorAPI-BGP/
├── topology.yml                # Containerlab topology definition
├── bgp-config.yml             # Ansible playbook for BGP configuration
├── create-links.sh            # Network link creation script (macOS workaround)
├── clab-multi-vendor-api-bgp/ # Generated by containerlab
│   └── ansible-inventory.yml  # Auto-generated inventory
└── containerlabssetup.md      # Deployment commands reference
```

## Prerequisites

- Docker Desktop (running)
- Ansible (for macOS: `pip install ansible`, for WSL: `pip3 install ansible`)

## Quick Start

### 1. Deploy Containerlab Topology

**Bash (macOS/Linux/WSL):**
```bash
docker run --rm -it --privileged \
  --network host \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v $(pwd):/lab \
  -w /lab \
  ghcr.io/srl-labs/clab containerlab deploy -t topology.yml \
  --reconfigure
```

**PowerShell (Windows):**
```powershell
docker run --rm -it --privileged `
  --network host `
  -v /var/run/docker.sock:/var/run/docker.sock `
  -v ${PWD}:/lab `
  -w /lab `
  ghcr.io/srl-labs/clab containerlab deploy -t topology.yml `
  --reconfigure
```

### 2. Configure BGP via Ansible

**macOS:**
```bash
ansible-playbook -i clab-multi-vendor-api-bgp/ansible-inventory.yml bgp-config.yml
```

**WSL:**
```bash
wsl
cd /mnt/c/ContainerLabsProjects/multiVendorAPI-BGP
ansible-playbook -i clab-multi-vendor-api-bgp/ansible-inventory.yml bgp-config.yml
```

### 3. Verify BGP Sessions and Connectivity

```bash
# Check FRR1 BGP status (should show Established with gobgp1)
docker exec clab-multi-vendor-api-bgp-frr1 vtysh -c "show bgp summary"

# Check GoBGP1 neighbors (should show Established with frr1)
docker exec clab-multi-vendor-api-bgp-gobgp1 gobgp neighbor

# Verify interfaces have correct IPs
docker exec clab-multi-vendor-api-bgp-frr1 ip addr
docker exec clab-multi-vendor-api-bgp-client1 ip addr

# Test end-to-end connectivity (client1 to client2)
docker exec clab-multi-vendor-api-bgp-client1 ping -c 3 10.0.3.3
```

**Expected result:** Ping should succeed with 0% packet loss, confirming BGP is advertising routes correctly.

### 4. Cleanup

**Bash:**
```bash
docker run --rm -it --privileged \
  --network host \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v $(pwd):/lab \
  -w /lab \
  ghcr.io/srl-labs/clab containerlab destroy -t topology.yml
```

**PowerShell:**
```powershell
docker run --rm -it --privileged `
  --network host `
  -v /var/run/docker.sock:/var/run/docker.sock `
  -v ${PWD}:/lab `
  -w /lab `
  ghcr.io/srl-labs/clab containerlab destroy -t topology.yml
```

## How It Works

1. **Topology Deployment**: Containerlab creates Docker containers (link creation may fail on Docker Desktop)
2. **Link Creation** (via Ansible playbook):
   - Uses Docker native networking instead of veth pairs
   - Creates /29 subnets (Docker reserves .1 IP as gateway)
   - Connects containers using `docker network connect`
   - Platform-independent solution (works on macOS, Windows/WSL, and Linux)
3. **BGP Configuration**:
   - FRR1: Configured via vtysh CLI using `docker exec`
   - GoBGP1: Configured via gRPC API using `gobgp` CLI
4. **Route Injection**: Static routes added to clients for reachability testing

**Network Topology:**
- Link 1 (10.0.1.0/29): client1 (10.0.1.2) <--> frr1 (10.0.1.3)
- Link 2 (10.0.2.0/29): frr1 (10.0.2.2) <--> gobgp1 (10.0.2.3)
- Link 3 (10.0.3.0/29): gobgp1 (10.0.3.2) <--> client2 (10.0.3.3)
- Gateway IPs (.1) are reserved by Docker but unused

## Platform-Specific Notes

### macOS
- Docker Desktop provides Linux VM layer
- Ansible can be run from macOS host

### Windows/WSL
- Ansible must run from WSL (not native Windows PowerShell)
- Docker Desktop bridge allows WSL to manage containers

## Troubleshooting

**Docker not running:**
```
ERROR: The system cannot find the file specified
```
Solution: Start Docker Desktop

**Ansible SSH timeouts:**
```
Failed to connect to the host via ssh: Connection timed out
```
Solution: Ensure `gather_facts: no` in `bgp-config.yml` (Ansible uses `docker exec`, not SSH)

**Address already in use:**
```
Error response from daemon: Address already in use
```
Solution: This happens if Docker's gateway IP conflicts with container IPs. The playbook uses /29 subnets with Docker taking .1 as gateway and containers using .2 and .3. If you modify IP addresses, ensure they don't conflict with Docker's automatic gateway assignment.

**Containerlab link creation fails:**
```
ERRO failed deploy links for node "client1": failed to Statfs "/proc/xxxx/ns/net"
```
This is expected on Docker Desktop - containerlab's link creation has race conditions. The Ansible playbook creates links using Docker native networking as a workaround.

**BGP not establishing:**
Check interfaces are up and have correct IPs:
```bash
docker exec clab-multi-vendor-api-bgp-frr1 vtysh -c "show bgp summary"
docker exec clab-multi-vendor-api-bgp-frr1 ip addr
```

## Key Features

- Multi-vendor BGP demonstration (FRR + GoBGP)
- API-driven configuration (CLI + gRPC)
- Cross-platform support (macOS/Windows/Linux)
- Automated with Ansible
- Self-documenting with inline comments

