---
- name: Configure BGP via REST APIs
  hosts: localhost
  gather_facts: no
  
  vars:
    gobgp_api: "http://localhost:8080"
    
  tasks:
    # Task execution order:
    # 1. Enable FRR daemons
    # 2. Create network links
    # 3. Configure GoBGP via REST API
    # 4. Configure FRR via vtysh CLI
    # 5. Configure clients

    # === STEP 1: Enable FRR routing daemons ===
    - name: Enable zebra and bgpd on FRR1
      shell: |
        docker exec clab-multi-vendor-api-bgp-frr1 sed -i 's/zebra=no/zebra=yes/' /etc/frr/daemons
        docker exec clab-multi-vendor-api-bgp-frr1 sed -i 's/bgpd=no/bgpd=yes/' /etc/frr/daemons
        docker exec clab-multi-vendor-api-bgp-frr1 pkill -HUP watchfrr || true
        sleep 5

    # === STEP 2: Create network links ===
    - name: Create network links between containers
      shell: |
        docker run --rm --privileged \
          --network=host \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v {{ playbook_dir }}:/workspace \
          ghcr.io/srl-labs/clab sh /workspace/create-links.sh

    # === STEP 3: Configure GoBGP via REST API ===
    - name: Configure GoBGP via REST API
      uri:
        url: "{{ item.url }}"
        method: POST
        body_format: json
        body: "{{ item.body }}"
        status_code: [200, 201, 204]
      loop:
        - url: "{{ gobgp_api }}/v1/global"
          body:
            global:
              as: 65002
              router_id: "2.2.2.2"
              listen_port: 179
        - url: "{{ gobgp_api }}/v1/neighbor"
          body:
            peer:
              conf:
                neighbor_address: "10.0.2.2"
                peer_as: 65001
              transport:
                config:
                  local_address: "10.0.2.3"
        - url: "{{ gobgp_api }}/v1/global/rib"
          body:
            table_type: 0
            path:
              nlri:
                prefix: "10.0.3.0/29"
              pattrs:
                - type: 1
                  origin: 0
                - type: 3
                  nexthop: "10.0.2.3"

    # === STEP 4: Configure FRR via vtysh CLI ===
    - name: Configure interfaces and BGP on FRR1
      shell: |
        docker exec clab-multi-vendor-api-bgp-frr1 vtysh \
          -c 'configure terminal' \
          -c 'interface eth1' \
          -c 'ip address 10.0.1.3/29' \
          -c 'exit' \
          -c 'interface eth2' \
          -c 'ip address 10.0.2.2/29' \
          -c 'exit' \
          -c 'router bgp 65001' \
          -c 'bgp router-id 1.1.1.1' \
          -c 'neighbor 10.0.2.3 remote-as 65002' \
          -c 'address-family ipv4 unicast' \
          -c 'neighbor 10.0.2.3 activate' \
          -c 'network 10.0.1.0/29' \
          -c 'exit-address-family' \
          -c 'exit'

    # === STEP 5: Configure clients ===
    - name: Configure client1 interface and routing
      shell: |
        docker exec clab-multi-vendor-api-bgp-client1 ip addr add 10.0.1.2/29 dev eth1 || true
        docker exec clab-multi-vendor-api-bgp-client1 ip route add 10.0.0.0/8 via 10.0.1.3 || true

    - name: Configure client2 interface and routing
      shell: |
        docker exec clab-multi-vendor-api-bgp-client2 ip addr add 10.0.3.3/29 dev eth1 || true
        docker exec clab-multi-vendor-api-bgp-client2 ip route add 10.0.0.0/8 via 10.0.3.2 || true
