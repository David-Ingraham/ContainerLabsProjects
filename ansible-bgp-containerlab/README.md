# BGP Lab with ContainerLab and Automation
Not currently working with og topolgy. frr1 and gogbp are not sharing routes
Network automation lab demonstrating BGP configuration between FRR and GoBGP routers using Ansible and gRPC. 

## Directory Structure

```
ansible-bgp-containerlab/
├── README.md
├── containerlab/
│   └── topology.yml              # ContainerLab topology definition
├── docker/
│   ├── Dockerfile.automation     # Automation container with Ansible + gRPC
│   └── Dockerfile.frr            # FRR container with SSH + credentials
├── ansible/
│   ├── inventory.yml             # Network configuration and BGP parameters
│   ├── playbooks/
│   │   └── config_playbook.yml   # BGP configuration playbook
│   └── credentials/
│       ├── credentials.env       # Source credentials (create manually)
│       └── credentials.yml       # Generated Ansible credentials
├── scripts/
│   ├── python/
│   │   ├── configure_gobgp.py    # GoBGP gRPC configuration
│   │   └── create_links.py       # Data plane network setup
│   └── shell/
│       ├── setup.ps1             # Windows setup script
│       ├── setup.sh              # Linux/macOS setup script
│       ├── verify-bgp.ps1        # Windows verification
│       ├── verify-bgp.sh         # Linux/macOS verification
│       └── checkGobgpStatus.sh   # Quick GoBGP status
├── docs/
│   └── walk_through.txt          # Setup walkthrough notes
└── clab-bgp-lab/                 # Generated by ContainerLab
```

## Prerequisites

- Docker installed and running
- Python 3.x (for create_links.py)
- Access to containerlab image (ghcr.io/srl-labs/clab)
- Platform support:
  - Linux/macOS: scripts/shell/setup.sh
  - Windows: scripts/shell/setup.ps1 (PowerShell)

## Network Topology

```
                          [frr2] -------- [receiver1] [receiver2]
                            |             10.2.0.10   10.2.0.20
                         10.1.0.3              (10.2.0.0/24)
                            |
host1 (10.1.0.10) -- [frr1 10.1.0.2] --------- [gobgp1] -- host2 (10.3.0.10)
                                     10.0.1.x   10.3.0.2
                     (10.1.0.0/24)             (10.3.0.0/24)
```

### Management Network: 10.1.1.0/24

| Node | IP | Role |
|------|-----|------|
| Automation | 10.1.1.10 | Ansible controller |
| FRR1 | 10.1.1.11 | BGP router, multicast FHR |
| FRR2 | 10.1.1.12 | BGP router, multicast LHR |
| GoBGP1 | 10.1.1.13 | BGP router |
| Host1 | 10.1.1.20 | Multicast source |
| Host2 | 10.1.1.21 | Endpoint |
| Receiver1 | 10.1.1.22 | Multicast receiver |
| Receiver2 | 10.1.1.23 | Multicast receiver |

### Data Plane Networks

| Network | Subnet | Connected Nodes |
|---------|--------|-----------------|
| frr1-network | 10.1.0.0/24 | frr1 (.2), frr2 (.3), host1 (.10) |
| frr2-network | 10.2.0.0/24 | frr2 (.2), receiver1 (.10), receiver2 (.20) |
| gobgp-network | 10.3.0.0/24 | gobgp1 (.2), host2 (.10) |
| link-frr1-gobgp1 | 10.0.1.0/29 | frr1 (.2), gobgp1 (.3) |

### BGP Configuration

| Router | AS | Router ID | Neighbors |
|--------|-----|-----------|-----------|
| FRR1 | 65001 | 1.1.1.1 | gobgp1 (10.0.1.3), frr2 (10.1.0.3) |
| FRR2 | 65003 | 3.3.3.3 | frr1 (10.1.0.2) |
| GoBGP1 | 65002 | 2.2.2.2 | frr1 (10.0.1.2) |

## Credentials Management

### credentials.env (required, gitignored)

Create this file at `ansible/credentials/credentials.env`:

```
FRR_ROOT_PASS=<root-password>
FRR_USER=<ansible-username>
FRR_PASS=<ansible-password>
```

This file is:
- Used at image build time to bake credentials into the FRR Docker image
- Sourced by setup scripts to generate credentials.yml
- Listed in .gitignore (not committed to version control)

### credentials.yml (auto-generated)

The setup scripts generate `ansible/credentials/credentials.yml` from credentials.env:

```yaml
ansible_user: <value-from-FRR_USER>
ansible_password: <value-from-FRR_PASS>
```

## Quick Start

### 1. Create Credentials

```bash
# Create credentials file
cat > ansible/credentials/credentials.env << EOF
FRR_ROOT_PASS=root123
FRR_USER=ansible
FRR_PASS=ansible123
EOF
```

### 2. Deploy Infrastructure

```powershell
# Windows
.\scripts\shell\setup.ps1
```

```bash
# Linux/macOS
./scripts/shell/setup.sh
```

### 3. Configure BGP

```bash
docker exec -it clab-bgp-lab-automation ansible-playbook -i inventory.yml config_playbook.yml
```

### 4. Verify

```powershell
# Windows
.\scripts\shell\verify-bgp.ps1
```

```bash
# Linux/macOS
./scripts/shell/verify-bgp.sh
```

## Components

### FRR Container Image

Defined in [docker/Dockerfile.frr](docker/Dockerfile.frr):

- Base image: frrouting/frr:latest
- BGP and Zebra daemons enabled
- SSH server installed and configured
- Ansible user created with vtysh shell
- Credentials baked in at build time

### Automation Container

Defined in [docker/Dockerfile.automation](docker/Dockerfile.automation):

- Base image: python:3.11-slim
- Python packages: ansible, grpcio, grpcio-tools, protobuf, netmiko, paramiko
- Ansible collections: frr.frr, ansible.netcommon
- GoBGP gRPC stubs compiled from proto files

### Topology Definition

[containerlab/topology.yml](containerlab/topology.yml) defines:

- Management network (10.1.1.0/24)
- All container nodes with management IPs
- FRR runtime initialization (SSH, FRR daemons)
- GoBGP with gRPC API on port 50051

### Inventory Configuration

[ansible/inventory.yml](ansible/inventory.yml) contains:

- Router-to-router link definitions (point-to-point subnets)
- Backend network definitions (host subnets)
- BGP parameters (AS numbers, router IDs, neighbors)
- Multi-neighbor support for FRR routers

### Data Plane Setup

[scripts/python/create_links.py](scripts/python/create_links.py) reads inventory.yml and:

- Creates Docker networks for each subnet
- Connects containers to appropriate networks with assigned IPs
- Configures default routes on host containers
- Enables IP forwarding on routers
- Verifies connectivity between routers

### BGP Configuration Playbook

[ansible/playbooks/config_playbook.yml](ansible/playbooks/config_playbook.yml):

1. Configures GoBGP via Python gRPC script
2. Configures FRR routers via Ansible frr.frr.frr_bgp module
3. Supports multiple BGP neighbors per router
4. Applies route-maps for route exchange

## Setup Process

The setup scripts perform:

1. Source credentials.env and generate credentials.yml
2. Build Docker images if not present
3. Clean up existing containers and networks
4. Deploy ContainerLab topology
5. Wait for container stabilization
6. Configure data plane networks (create_links.py)
7. Enable IP forwarding and add static routes on GoBGP
8. Copy configuration files to automation container

### GoBGP Kernel Routing

GoBGP is a BGP daemon only - it does not install routes into the kernel. The setup scripts run an Alpine container in GoBGP's network namespace to:

- Enable IP forwarding: `sysctl -w net.ipv4.ip_forward=1`
- Add static routes: `ip route add 10.1.0.0/24 via 10.0.1.2`

## Verification

### Quick Status

```bash
./scripts/shell/checkGobgpStatus.sh
```

### Full Verification

The verify scripts check:

- FRR1 and FRR2 BGP summary and routing tables
- GoBGP neighbor status and global RIB
- End-to-end connectivity tests:
  - Host1 to Host2 (through frr1 -> gobgp1)
  - Host2 to Host1 (return path)
  - Receiver1 to Host1 (through frr2 -> frr1)
  - Host1 to Receiver1 (multicast path)
  - Receiver1 to Host2 (full path)

### Expected End State

- All BGP neighbors in Established state
- Route exchange:
  - FRR1 learns 10.3.0.0/24 from GoBGP1
  - FRR1 learns 10.2.0.0/24 from FRR2
  - FRR2 learns 10.1.0.0/24 and 10.3.0.0/24 from FRR1
  - GoBGP1 learns 10.1.0.0/24 from FRR1
- All connectivity tests pass

## Troubleshooting

### Container Status

```bash
docker ps
```

Expected containers:
- clab-bgp-lab-automation
- clab-bgp-lab-frr1
- clab-bgp-lab-frr2
- clab-bgp-lab-gobgp1
- clab-bgp-lab-host1
- clab-bgp-lab-host2
- clab-bgp-lab-receiver1
- clab-bgp-lab-receiver2

### Direct Container Access

```bash
# FRR CLI
docker exec -it clab-bgp-lab-frr1 vtysh

# GoBGP CLI
docker exec clab-bgp-lab-gobgp1 gobgp neighbor
docker exec clab-bgp-lab-gobgp1 gobgp global rib
```

### Common Issues

**Docker reserves .1 for gateway**: When creating Docker networks, .1 is reserved for the bridge gateway. Use .2 for router gateway IPs.

**GoBGP no shell**: The GoBGP image contains only the daemon. Use `docker run --network container:clab-bgp-lab-gobgp1 alpine sh -c "..."` to run commands in its namespace.

**BGP not advertising routes**: A router can only advertise networks it has in its routing table. Verify the interface is connected and has the correct IP.

## Lab Teardown

```bash
# Linux/macOS
docker run --rm -it --privileged --network host \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v $(pwd):/lab -w /lab \
  ghcr.io/srl-labs/clab containerlab destroy -t containerlab/topology.yml --cleanup
```

```powershell
# Windows
docker run --rm -it --privileged `
  --network host `
  -v /var/run/docker.sock:/var/run/docker.sock `
  -v ${PWD}:/lab `
  -w /lab `
  ghcr.io/srl-labs/clab containerlab destroy -t containerlab/topology.yml --cleanup
```

## Multicast Notes

The topology is designed for future multicast configuration:

- **Source**: host1 (10.1.0.10) on frr1's backend network
- **FHR (First Hop Router)**: frr1 - closest to the multicast source
- **LHR (Last Hop Router)**: frr2 - closest to the receivers
- **Receivers**: receiver1 (10.2.0.10), receiver2 (10.2.0.20) behind frr2

Multicast requires additional configuration (PIM, IGMP) not yet implemented. BGP provides the unicast routing table that PIM uses for RPF (Reverse Path Forwarding) checks.
