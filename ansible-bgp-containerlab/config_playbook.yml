---
# BGP Configuration Playbook
# Infrastructure (interfaces, IPs) already configured by setup.sh
# This playbook only handles BGP protocol configuration

- name: Configure GoBGP via gRPC API
  hosts: localhost
  gather_facts: no
  
  
  tasks:
    - name: Configure GoBGP BGP settings via Python gRPC
      command: python3 /workspace/configure_gobgp.py
      register: gobgp_result
      
    - name: Display GoBGP configuration result
      debug:
        var: gobgp_result.stdout_lines

- name: Prepare FRR for Ansible Access
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Create FRR user with vtysh shell for network_cli
      command: /workspace/prepare_frr_user.sh 
      register: frr_prep_result
      
    - name: Display FRR preparation result
      debug:
        var: frr_prep_result.stdout_lines

- name: Configure FRR via frr_bgp Module
  hosts: frr_routers
  gather_facts: no
  
  environment:
    ANSIBLE_HOST_KEY_CHECKING: False
  
  tasks:
    - name: Configure BGP on FRR using frr_bgp module
      frr.frr.frr_bgp:
        config:
          bgp_as: "{{ bgp_as }}"
          router_id: "{{ bgp_router_id }}"
          log_neighbor_changes: true
          neighbors:
            - neighbor: "{{ bgp_neighbor_ip }}"
              remote_as: "{{ bgp_neighbor_as }}"
              timers:
                keepalive: 30
                holdtime: 90
          networks:
            - prefix: "{{ advertise_network.split('/')[0] }}"
              masklen: "{{ advertise_network.split('/')[1] | int }}"
        operation: merge
      register: bgp_config_result
      
    - name: Display BGP configuration changes
      debug:
        var: bgp_config_result.commands
      when: bgp_config_result.changed
    
    - name: Configure route-map to permit all routes
      ansible.netcommon.cli_config:
        config: |
          route-map PERMIT-ALL permit 10
          exit
          router bgp {{ bgp_as }}
           address-family ipv4 unicast
            neighbor {{ bgp_neighbor_ip }} route-map PERMIT-ALL in
            neighbor {{ bgp_neighbor_ip }} route-map PERMIT-ALL out
           exit-address-family
      register: routemap_result
    
    - name: Display route-map configuration
      debug:
        msg: "Route-map PERMIT-ALL configured for neighbor {{ bgp_neighbor_ip }}"
      when: routemap_result.changed
      
    - name: Wait for BGP session to establish
      pause:
        seconds: 10
        
    - name: Verify BGP neighbor status
      ansible.netcommon.cli_command:
        command: show bgp summary
      register: bgp_status
      
    - name: Display BGP status
      debug:
        var: bgp_status.stdout_lines
        
    - name: Show BGP routes
      ansible.netcommon.cli_command:
        command: show bgp ipv4 unicast
      register: bgp_routes
      
    - name: Display BGP routes
      debug:
        var: bgp_routes.stdout_lines

