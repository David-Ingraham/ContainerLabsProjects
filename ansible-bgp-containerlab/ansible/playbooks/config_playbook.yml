---
# BGP Configuration Playbook
# Infrastructure (interfaces, IPs) already configured by setup.sh / create_links.py
# This playbook configures BGP protocol on all routers
#
# Multicast Note:
# BGP provides the unicast routing table that PIM uses to build multicast trees.
# PIM does "RPF check" (Reverse Path Forwarding) using the unicast routing table
# to determine the correct interface toward the source.

- name: Configure GoBGP via gRPC API
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Check if gobgp_routers group exists and has hosts
      set_fact:
        has_gobgp: "{{ groups['gobgp_routers'] is defined and groups['gobgp_routers'] | length > 0 }}"
    
    - name: Configure GoBGP BGP settings via Python gRPC
      command: python3 /workspace/configure_gobgp.py
      register: gobgp_result
      ignore_errors: yes
      when: has_gobgp | bool
      
    - name: Display GoBGP configuration result
      debug:
        var: gobgp_result.stdout_lines
      when: 
        - has_gobgp | bool
        - gobgp_result.stdout_lines is defined
    
    - name: Skip message
      debug:
        msg: "No GoBGP routers in inventory, skipping GoBGP configuration"
      when: not (has_gobgp | bool)

- name: Configure FRR BGP (Multi-Neighbor Support)
  hosts: frr_routers
  gather_facts: no
  vars_files:
    - credentials.yml
  
  environment:
    ANSIBLE_HOST_KEY_CHECKING: False
  
  tasks:
    - name: Display router being configured
      debug:
        msg: "Configuring {{ inventory_hostname }} (AS {{ bgp_as }}, Router-ID {{ bgp_router_id }})"

    # Build networks list in format comptatible with frr_bgp module
    # Convert ["10.1.0.0/24"] to [{prefix: "10.1.0.0", masklen: 24}]
    - name: Build networks configuration
      set_fact:
        bgp_networks: "{{ advertise_networks | default([]) | map('regex_replace', '^(.+)/(.+)$', '{\"prefix\": \"\\1\", \"masklen\": \\2}') | map('from_json') | list }}"
      when: advertise_networks is defined and advertise_networks | length > 0

    - name: Configure BGP with multiple neighbors
      frr.frr.frr_bgp:
        config:
          bgp_as: "{{ bgp_as }}"
          router_id: "{{ bgp_router_id }}"
          log_neighbor_changes: true
          neighbors: "{{ bgp_neighbors }}"
          networks: "{{ bgp_networks | default([]) }}"
        operation: merge
      register: bgp_config_result
      
    - name: Display BGP configuration changes
      debug:
        var: bgp_config_result.commands
      when: bgp_config_result.changed

    # Configure route-maps for each neighbor
    # Route-maps control what routes are accepted/advertised
    - name: Configure route-maps for BGP neighbors
      ansible.netcommon.cli_config:
        config: |
          route-map PERMIT-ALL permit 10
          exit
          router bgp {{ bgp_as }}
           address-family ipv4 unicast
          {% for neighbor in bgp_neighbors %}
            neighbor {{ neighbor.neighbor }} route-map PERMIT-ALL in
            neighbor {{ neighbor.neighbor }} route-map PERMIT-ALL out
          {% endfor %}
           exit-address-family
      register: routemap_result
    
    - name: Display route-map configuration
      debug:
        msg: "Route-maps configured for {{ bgp_neighbors | length }} neighbor(s)"
      when: routemap_result.changed

- name: Verify BGP Status on All Routers
  hosts: frr_routers
  gather_facts: no
  serial: 1
  vars_files:
    - credentials.yml
  
  environment:
    ANSIBLE_HOST_KEY_CHECKING: False
  
  tasks:
    - name: Wait for BGP sessions to establish
      pause:
        seconds: 5
      run_once: true
        
    - name: Get BGP summary
      ansible.netcommon.cli_command:
        command: show bgp summary
      register: bgp_status
      
    - name: Display BGP status for {{ inventory_hostname }}
      debug:
        msg: "{{ bgp_status.stdout_lines }}"
        
    - name: Get BGP routes
      ansible.netcommon.cli_command:
        command: show bgp ipv4 unicast
      register: bgp_routes
      
    - name: Display BGP routes for {{ inventory_hostname }}
      debug:
        msg: "{{ bgp_routes.stdout_lines }}"

- name: Configure PIM for Multicast
  hosts: frr_routers
  gather_facts: no
  vars_files:
    - credentials.yml
  
  environment:
    ANSIBLE_HOST_KEY_CHECKING: False
  
  tasks:
    - name: Display router being configured for multicast
      debug:
        msg: "Configuring PIM on {{ inventory_hostname }} (RP: {{ pim_rp_address }})"
    
    - name: Enable PIM on all interfaces 
      ansible.netcommon.cli_config:
        config: |
          {% for interface in pim_interfaces %}
          interface {{ interface }}
           ip pim
          {% endfor %}
      register: pim_interface_result
    
    - name: Configure RP address #statically telling routers who RP it, implementing BSR (bootstrap router will lets router elect a router to advertize the rp)
      ansible.netcommon.cli_config:
        config: |
          ip pim rp {{ pim_rp_address }}
      register: pim_rp_result
    
    - name: Enable IGMP on receiver-facing interfaces
      ansible.netcommon.cli_config:
        config: |
          {% for interface in igmp_interfaces | default([]) %}
          interface {{ interface }}
           ip igmp
          {% endfor %}
      register: igmp_result
      when: igmp_interfaces is defined
    
    - name: Display PIM configuration status
      debug:
        msg: "PIM configured on {{ pim_interfaces | length }} interface(s), RP: {{ pim_rp_address }}"

- name: Verify PIM Status
  hosts: frr_routers
  gather_facts: no
  serial: 1
  vars_files:
    - credentials.yml
  
  environment:
    ANSIBLE_HOST_KEY_CHECKING: False
  
  tasks:
    - name: Wait for PIM neighbors to establish
      pause:
        seconds: 5
      run_once: true
    
    - name: Get PIM neighbor status
      ansible.netcommon.cli_command:
        command: show ip pim neighbor
      register: pim_neighbors
      
    - name: Display PIM neighbors for {{ inventory_hostname }}
      debug:
        msg: "{{ pim_neighbors.stdout_lines }}"
    
    - name: Get PIM interface status
      ansible.netcommon.cli_command:
        command: show ip pim interface
      register: pim_interfaces_status
      
    - name: Display PIM interfaces for {{ inventory_hostname }}
      debug:
        msg: "{{ pim_interfaces_status.stdout_lines }}"
    
    - name: Get PIM RP info
      ansible.netcommon.cli_command:
        command: show ip pim rp-info
      register: pim_rp_info
      
    - name: Display PIM RP info for {{ inventory_hostname }}
      debug:
        msg: "{{ pim_rp_info.stdout_lines }}"
