---
# BGP Configuration Playbook
# Infrastructure (interfaces, IPs) already configured by setup.sh / create_links.py
# This playbook configures BGP protocol on all routers
#
# Multicast Note:
# BGP provides the unicast routing table that PIM uses to build multicast trees.
# PIM does "RPF check" (Reverse Path Forwarding) using the unicast routing table
# to determine the correct interface toward the source.

- name: Configure GoBGP via gRPC API
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Configure GoBGP BGP settings via Python gRPC
      command: python3 /workspace/configure_gobgp.py
      register: gobgp_result
      ignore_errors: yes
      
    - name: Display GoBGP configuration result
      debug:
        var: gobgp_result.stdout_lines
      when: gobgp_result.stdout_lines is defined

- name: Configure FRR BGP (Multi-Neighbor Support)
  hosts: frr_routers
  gather_facts: no
  vars_files:
    - credentials.yml
  
  environment:
    ANSIBLE_HOST_KEY_CHECKING: False
  
  tasks:
    - name: Display router being configured
      debug:
        msg: "Configuring {{ inventory_hostname }} (AS {{ bgp_as }}, Router-ID {{ bgp_router_id }})"

    # Build networks list for frr_bgp module
    # Convert ["10.1.0.0/24"] to [{prefix: "10.1.0.0", masklen: 24}]
    - name: Build networks configuration
      set_fact:
        bgp_networks: "{{ advertise_networks | default([]) | map('regex_replace', '^(.+)/(.+)$', '{\"prefix\": \"\\1\", \"masklen\": \\2}') | map('from_json') | list }}"
      when: advertise_networks is defined and advertise_networks | length > 0

    - name: Configure BGP with multiple neighbors
      frr.frr.frr_bgp:
        config:
          bgp_as: "{{ bgp_as }}"
          router_id: "{{ bgp_router_id }}"
          log_neighbor_changes: true
          neighbors: "{{ bgp_neighbors }}"
          networks: "{{ bgp_networks | default([]) }}"
        operation: merge
      register: bgp_config_result
      
    - name: Display BGP configuration changes
      debug:
        var: bgp_config_result.commands
      when: bgp_config_result.changed

    # Configure route-maps for each neighbor
    # Route-maps control what routes are accepted/advertised
    - name: Configure route-maps for BGP neighbors
      ansible.netcommon.cli_config:
        config: |
          route-map PERMIT-ALL permit 10
          exit
          router bgp {{ bgp_as }}
           address-family ipv4 unicast
          {% for neighbor in bgp_neighbors %}
            neighbor {{ neighbor.neighbor }} route-map PERMIT-ALL in
            neighbor {{ neighbor.neighbor }} route-map PERMIT-ALL out
          {% endfor %}
           exit-address-family
      register: routemap_result
    
    - name: Display route-map configuration
      debug:
        msg: "Route-maps configured for {{ bgp_neighbors | length }} neighbor(s)"
      when: routemap_result.changed

- name: Verify BGP Status on All Routers
  hosts: frr_routers
  gather_facts: no
  serial: 1
  vars_files:
    - credentials.yml
  
  environment:
    ANSIBLE_HOST_KEY_CHECKING: False
  
  tasks:
    - name: Wait for BGP sessions to establish
      pause:
        seconds: 5
      run_once: true
        
    - name: Get BGP summary
      ansible.netcommon.cli_command:
        command: show bgp summary
      register: bgp_status
      
    - name: Display BGP status for {{ inventory_hostname }}
      debug:
        msg: "{{ bgp_status.stdout_lines }}"
        
    - name: Get BGP routes
      ansible.netcommon.cli_command:
        command: show bgp ipv4 unicast
      register: bgp_routes
      
    - name: Display BGP routes for {{ inventory_hostname }}
      debug:
        msg: "{{ bgp_routes.stdout_lines }}"

# Future: Add PIM configuration play
# - name: Configure PIM for Multicast
#   hosts: frr_routers
#   tasks:
#     - name: Enable PIM on interfaces
#       # PIM must be enabled on all interfaces that will forward multicast
#     - name: Configure RP (Rendezvous Point)
#       # For PIM-SM, all routers need to know the RP address
